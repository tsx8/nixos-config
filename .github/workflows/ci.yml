name: "CI Checks"

on:
  push:
    branches:
      - master
    paths:
      - "**.nix"
      - "flake.lock"
      - ".github/workflows/**"
      - "configs/**"
      - "secrets/**"
      - ".sops.yaml"

jobs:
  run-checks:
    name: "Run Flake Checks"
    runs-on: ubuntu-latest
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: actions/checkout@v4
      - name: "Free Disk Space"
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: "Set Swap Space"
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false
      - uses: DeterminateSystems/flake-checker-action@main
      - name: "Run Nix Flake Check"
        env:
          GITHUB_ACTIONS: "true"
        run: nix flake check --impure --all-systems --print-build-logs
